<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!--=============== REMIXICONS ===============-->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet" />

  <!--=============== CSS ===============-->
  <link rel="stylesheet" href="login_design.css" />

  <style>
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 15px 20px;
      background-color: #333;
      color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification.error {
      background-color: #e74c3c;
    }
    .notification.success {
      background-color: #2ecc71;
    }
  </style>

  <title>Login - BLUE16</title>
</head>
<body>
  <section>
    <div class="wave">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <div class="container">
      <h1 class="login__title">Login</h1>

      <div class="login__content">
        <div class="login__box">
          <i class="ri-user-3-line login__icon"></i>
          <div class="login__box-input">
            <input
              type="text"
              required
              class="login__input"
              id="login-username"
              placeholder=" "
            />
            <label for="login-username" class="login__label">Username</label>
          </div>
        </div>

        <div class="login__box">
          <i class="ri-lock-2-line login__icon"></i>
          <div class="login__box-input">
            <input
              type="password"
              required
              class="login__input"
              id="login-pass"
              placeholder=" "
            />
            <label for="login-pass" class="login__label">Password</label>
            <i class="ri-eye-off-line login__eye" id="login-eye"></i>
          </div>
        </div>
      </div>

      <button id="login-button" class="login__button">Login</button>

      <p class="login__register">
        Don't have an account?
        <a href="/blue16-web/register.html">Register</a>
      </p>
    </div>
  </section>

  <div id="notification-container"></div>

  <script>

import { createClient } from '@supabase/supabase-js'
const supabaseUrl = 'https://pspjvpipyvpvyixahsku.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzcGp2cGlweXZwdnlpeGFoc2t1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyODU4MTQsImV4cCI6MjA2Mjg2MTgxNH0.K3qGEv9Pz-oSNfocFlVkh8ujQp0YZ85z9VlKGI1WXD8'
const supabase = createClient(supabaseUrl, supabaseKey)

    function showNotification(message, type = 'success') {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      container.appendChild(notification);

      // animate in
      setTimeout(() => notification.classList.add('show'), 10);
      // remove after show
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    async function isPwned(password) {
      const buffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-1', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
      const prefix = hashHex.slice(0, 5);
      const suffix = hashHex.slice(5);

      const response = await fetch(`https://api.pwnedpasswords.com/range/${prefix}`);
      const text = await response.text();
      const lines = text.split('\r\n');
      for (const line of lines) {
        const [hashTail, count] = line.split(':');
        if (hashTail === suffix) {
          return parseInt(count, 10);
        }
      }
      return 0;
    }

    document.getElementById('login-button').addEventListener('click', async (event) => {
      event.preventDefault();

      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-pass').value;

      if (!username || !password) {
        showNotification('Please fill in both fields.', 'error');
        return;
      }

      try {
        // Check breach
        const breaches = await isPwned(password);
        if (breaches > 0) {
          showNotification(`Your password appeared in ${breaches} breaches. Please change the password adter you log-in.`, 'success');
          setTimeout(() => {
  window.location.href = '/dashboard/';
}, 3000);
        }

        // Supabase Auth
        const { data, error } = await supabase.auth.signInWithPassword({
          email: username,
          password: password
        });

        if (error) {
          showNotification(error.message, 'error');
        } else {
          localStorage.setItem('username', username);
          showNotification('Login successful!', 'success');
          setTimeout(() => {
            window.location.href = '/dashboard/';
          }, 1000);
        }
      } catch (err) {
        console.error('Login failed:', err);
        showNotification('Login failed for unknown reason. Please try again.', 'error');
      }
    });

    // Toggle password visibility
    const passwordInput = document.getElementById('login-pass');
    const eyeIcon = document.getElementById('login-eye');
    eyeIcon.addEventListener('click', () => {
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.replace('ri-eye-off-line', 'ri-eye-line');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.replace('ri-eye-line', 'ri-eye-off-line');
      }
    });

    // Offline check
    fetch('https://blue16-team.github.io/blue16-web/values.json')
      .then(res => res.json())
      .then(data => { if (data.offline) window.location.href = 'offline.html'; })
      .catch(console.error);
  </script>
</body>
</html>
